import * as THREE from 'three';
import {loadObjects, glbLoader, calculateThrust, calculateDrag, OBB, lerpEuler, calculateLinearIntegration}  from "./helper.js"


var forward = new THREE.Vector3(0, 0, -1)
var backward = new THREE.Vector3(0, 0, 1)

const defaultRotation = new THREE.Euler(3.14/2, 0, 3.14/2)

// 1231003126277261220512480017646075364607534208316101001723217171717171717171717171717171717171717171717171717171717171717175124806460753320227431180311803543420303124031240342712329403236162202343118031311231941210228124462064607530123200312810322436551410122370236023502340233023201014365521110211365521110162370236023502340233023202310230022903655215103119365515101223702360102103655010036552111015365521310172370101936560101236560365521110311436551210133655132270228023712101636550101236552151015365521510122370236023502340101936560101336560101236551810311336551610152371210163657010133656036552121016365519100365613101423701021236560101336560101236552101031113655191002370236023701016365701013365603655028003656121401003655181015365516101336561310142370102163656010123655214103107365517237023602350234010023701012365512101236570101527102800279027802410237036560237036551410143655173657010133656121015237010193655121019365601003655214103104365512101436560237010142370101236551610152800101323703656023703655131015365518102102370101836551410036570101636560101236552141031013655141012237023602350234010142370101236560365513101728001013237036560237010036551310153655143656121021123701021036550101236570102103655214103100365513100236023502340101723701012365601012365601017280010132280237023601021136551336560102112370102123655141021036552131031013655010211237010123656010123656010172800101236570100237010123655010212365601022736560100365701019365602710280036560365516103115237010153656010172800101236570101236551310242365701019365601002800365603655171031033655121019237010213280036551610244365701021128003656028012365515103103365601021023701023836570102253657121012365701017271028014365514103103365601021023701017365701022536550101436570102293657010036570101628013270027102800365603655010311423701017365701022536560102363657010123657010132801310122800365501031173655123657010228237036560101236570102363657010132801310122800365501031482370365601012365501023536551310122801310122800365701031463655010023701014365501023928013100365702800102663655010153655010267365519237010244280131003657010266365512102733655173657023702360101436550102392801336571210265365513101536551210268365516237010153656036551210310736551310153655151026436551523702360235010153656036550103108365613100365519102643655152370101736551210310836560100365601012365601003655010271365512100237010173655121031083656010143656010036560102703655142370101536570103118365601027323702360101536570103117365701012365712102702370101536551210311736551210036571210270237010153656010311736551236570100365712102702370103120365517365712102702370103118365519102722370103119365517102732370103199237036570103198237036570103198237036570103198237036570104176901410319601410319601410319601410237360701031580141031960141023700101336070103154323625410314632362541031463236254103146323625410314632362541315103141323625023702380323612131510314132362502381232361210121313103141323625023812323612101213010013010314132362502381232361210141301031413236245014323602381232361200151410218317901025818010258180101432360101325702120248010021901012312101014342701012257010152470212010025701016257010122500251010024702120100257001432360012323612015102183179010258180102481801019180101432360101325601013219010123120010172560101825601016256010182560101432780101232780323601014001021631811231830318112102211801023418010141801016317901023618010171912310001912101232360101332360324401012219010032450323601017323601018323601016323601018323603427010133278034271232780323601022131820318103183031810318201022118010232191231000190210010121801016317901022331790102101912310001902100101521001903100019021001012323601013323614219032361310163294032360100324503236032440324503236032440100323603295010143294032360100324503236032440324503236032440100323603295010133236151022231810318303181010220210019031000191210230191231000191210121801014318112318303181121022131790102102100190310001902100101621003100019010133236010133236025002510100219032360101932940323618329501016329403236183295010183236010222318203183031810102201912310001902100102311903100019010131801014318203181031830318103182010219318203181031830318112101919031000190101719031000190101332360101332360101432360102103294032361632950101832940323616329501019323601022331820102222100310001901023219031000210010131803558031000210010123181031830318101022031820318103183031810318201019190310001901021332360101232940323603244010123245032360329501024232360102462100310002100102372100310001903100019133182031830318201022131810318303181010226323601013329403236010032460323603295010243323601028518031001219123100019121003182010222318203183031820102263236010143294032361232950102443236010284180191231000191231000190210010225318201022732360101532940329501024532360102822100191331001219021012102553236034272523236010282210019133100019121025732362541028321001912310001902100103195210141051082833013610512420227219518674797069014980838566770136737084853156297334422031010101233442121003101031042293344191012252143109227100284031011236871310033432171012334419101235741331010512236227213557477776672700136737084851003162141014287320031621510121001001001002911231542751001001003151315710029102873158100316213296131005122572272135574777766727001367370848529603163123594010031620100100100316212316213316312361913100100313116334317100292010010010031621310010010010031631251227322721355747777667270013673708485327213100296031621210010031631232720100100100100296010031621331311831630100100100100316203343171001001001001034023207135124901010233512240023817512263025417512265027015512125101012512531101005123471010227512499101005124231010135125911010310032821010310047465101012512531101031163871101005125701010310049257101013512154101010
// 12310031251826722051248001664607536460753454181210100172321717171717171717171717171717171717171717171717171717171717171717512480646075332022823118031102653543420303124031240342712329403236162202393118031311231941235551510227124444264607530123200312810320532360102183655141012237023602350234023302320101436552111021136552111016237023602350234023302320231023002290365521510296323617102163655151012237023601021036550100365521110153655213101723701019365601012365603655211102953236171021236551210133655132270228023712101636550101236552151015365521510122370236023502340101936560101336560101236551810310132360102113655161015237121016365701013365603655212101636551910036561310142370102123656010133656010123655210102993236010211365519100237023602370101636570101336560365502800365612140100365518101536551610133656131014237010216365601012365521410295323601021136551723702360235023401002370101236551210123657010152710280027902780241023703656023703655141014365517365701013365612101523701019365512101936560100365521410292323601021136551210143656023701014237010123655161015280010132370365602370365513101536551810210237010183655141003657010163656010123655214102913236010193655141012237023602350234010142370101236560365513101728001013237036560237010036551310153655143656121021123701021036550101236570102103655214102903236010193655131002360235023401017237010123656010123656010172800101322802370236010211365513365601021123701021236551410210365521310289323601021136550102112370101236560101236560101728001012365701002370101236550102123656010227365601003657010193656027102800365603655161029132360102232370101536560101728001012365701012365513102423657010193656010028003656036551710290323601021236551210192370102132800365516102443657010211280036560280123655151029032360102123656010210237010238365701022536571210123657010172710280143655141029032360102123656010210237010173657010225365501014365701022936570100365701016280132700271028003656036550102903236010223237010173657010225365601023636570101236570101328013101228003655010291323601022536551236570102293656010123657010236365701013280131012280036550102913236010257365601012365501023536551310122801310122800365701029132360102543655010163655010239280131003657028001026636550101536550102193236010247365519102452801310036570102663655121022532360102473655173657010163655010239280133657121026536551310153655121021832360102493655161016365603655121031073655131015365515102153236010248365515237032360101636560365501031083656131003655191021532360102483655152370323601016365512103108365601003656010123656010036550102203236010250365512100237032360101636551210310836560101436560100365601022032360102493655142370323601014365701031183656010220323601025223702360323601014365701031173657010123657121021732360102522370100323601013365512103117365512100365712102173236010252237010032360101336560103117365512365701003657121021732360102522370100323601031183655173657121021732360102522370100323601031163655191021932360102522370100323601031173655171022032360102522370100323601031443236010252237036570323601031443236010252237036570323601031443236010252237036570323601031443236010252237036570323601031443236010254323601031443236010254323601031443236010254323601031443236010254323601031443236010254323601031443236010254323601031443236010254323601031443236010254323601031443236010223014102273236010314432360102230141022732360103144323601022301410227323601031443236010223014102273236010193607010313432360102230141022732360101800103134003236010223014102360121012237036070103129003236010223022510150161013015223022402250226022702280237132360103121003236010223023710000101201510120122371300103122323601022302451000142371300103122323601022302431014013237130010312232360102230250237130013151031173236121022202502371300131510311732361210222025023713001012131310311732360001022202502381223700010121301001301031170121021913121000250238122370001014130103117012102161300121017001014001018012101202282381223600121514102183179010258180102390121018131310160010242250025101014021510218317901025818010238120013101600101332240322501026700102163181123183031811210221180102341801014180101631790102260141312012102923182031810318303181031820102211801023219123100019021001012180101631790102230010000100012102983181031830318101022021001903100019121023019123100019121012180101431811231830318112103125318203183031810102201912310001902100102311903100019010131801014318203181031830318103182010312631820102222100310001901023219031000210010131803558031000210010123181031830318101031502100310002100102372100310001903100019133182031830318201031891803100121912310001912100318201031891801912310001912310001902100103189210019133100121902101210319121001913310001912103194210019123100019021001031952101410510828330134175122362272135574777766727001367370848510031621410142873200316215101629112315427510133151315710029102873158100316213296131005122572272135574777766727001367370848529603163123594010031620101331621231621331631236191310010031311633431710029201001001003162131001001001003163125122732272135574777766727001367370848532721310029603162121001003163123272010010010010029601003162133131183163010010010010031620334317100100100100103402319913512576101031004182210103100416231010135125011010310251240910101551233010101251253110100512347101022751208510101351259110101251253110100512570101031015116081010135121541010135123471010310338381010101242320646055502113200312810336332362351031653236123427002303236131031643236121023132361310316432361210319832361210319832361210319832361210319832361210319832361210319832361210319832361210319832361210318725921132361225922710163628010315327102801232430013324300133236122120003243001332430324600032460324300021200032430324600032460324300021200032430002120003243010151401031540028012324300133243001332361201232430013324300133243001332430013324300133243001332430103160324602801225900132590324400123236120032450259001325903246001225900123245025903246001225900123245025900123245025901015141210316432361210319832361210319832361210319832361210319832361210319832361210319832361210319832361210319832361210232140103165323612102322131210316432361210232213121031643236121023221312103164323612103198323612102320010316532361210232012103164323612102320014010316332361310233140103163003236121031970032361210319700323612103198323612103198323612103198323612102331401031643236121023214121031643236121023214121031643236121023214121031643236121031983236121031983236121031983236121031983236121031983236121031983236121031983236121031983236121031983236121031983236121031983236121031852380102123236121023523701031623236121023234210102522380102202380101523801022523801012238010256323612102663337018033370100180101433371218010289180102303236121025918010151912310001902100180100333701012333712180102873337010018010230323612101226103337010018010226140102211801013333701801015191231000191218010033370101219123100019121028519123100019121022832361210133337121801022714010211180333701016333701803337121003337018033370101521003100019123100019121012210019031000191210285210019031000190210010228323612101319121801902100102353337010018033370101521001903100019122100190310001912101421003100021001903100019021001013210031000190102872100310001901022932361819121016333701801003337010210333701801021319123100019021001014210019031000191431000190210010172100310001901014210031000190102871903100019010229323601015190180210010161912310001912102103337018010033370001021021001903100019121015190310001901012190310002100101821003100019010313219032360190101621001903100019021001019333712180100322401021219031000190101621003100019010122100310001901031443236224180323603226032250102111903100021001031672100310002100102101912310001903224121031951903100019010319721003100021001051180333013649429672272154674797084736671850136737084851012220212100284133162033121322018220143312141012290133218182883228291131003162121003336028414316212101328412290134297922721546747970847366718501367370848510033121429013331214316212100344702841228832212890100356801001001003728141001001002201710010034511329013100316212100429872272154674797084736671850136737084853312132202121003568029113100316212331212372815100100316203451121003312153312152841310028412321817356801001003162123218192841410042991227215467479708473667185013673708485220152911210037281235681231620331212284034710344701001001001003312141003312133728143218121001002911322021010029113356812284141034023192310051177010103107512789101013511827101013511646101015512210101013512212101012511644101031244297510102275116381010125117351010145122141010125116391010125116361010310051258410103124512377101010
// Plane class
class Plane {
	constructor(scene, modelUrl, id, crashHandler, finishedLoading = function () {}, errorLoading = function () {console.log("Error loading plane!")}) {
		this.modelUrl = modelUrl
		this.id = id
		this.scene = scene
		this.planeCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 10000 );
		this.planeArr = []
		this.plane = null
		this.finishedLoading = finishedLoading // function after plane is loaded
		this.errorLoading = errorLoading // function if there is error while loading

		// movement variables
		this.thrustLevel = 0
		this.goalThrustLevel = 0
		this.velocity = new THREE.Vector3(0,0,0)
		this.acceleration = new THREE.Vector3(0,0,0)
		this.e = new THREE.Vector3(0,0,0)

		this.targetRotation = new THREE.Euler(0, 0, 0)
		this.rotation = new THREE.Euler(0, 0, 0)

		this.onRunway = false
		this.crashHandler = crashHandler
		this.airspeed = 0
		this.oldPos = new THREE.Vector3()
	}

	// setup plane and camera
	planeLoadingDone() {
		this.plane = this.planeArr[0].scene.children[0]

		// change material from MeshPhysicalMaterial to MeshBasicMaterial
		const targetMaterial = new THREE.MeshBasicMaterial({ map: this.plane.children[0].material.map });
		targetMaterial.map.needsUpdate = true;
		this.plane.children[0].material = targetMaterial;

		// Initialize plane and camera
		this.plane.scale.set(0.001 * 32, 0.001 * 32, 0.001 * 32);
		this.plane.position.set(0, 40, 0);
		this.plane.rotation.setFromQuaternion(this.rotation)
		console.log(this.plane)
		this.scene.add(this.plane);


		this.planeCamera.position.set(this.plane.position.x, this.plane.position.y + 48, this.plane.position.z + 64);
		this.planeCamera.rotation.x = -3.14 / 8;
		console.log(this.plane)

		this.frontGearBox = new OBB(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 0.5, this.plane.position.z),
			new THREE.Vector3(1, 1, 1), 
			new THREE.Euler(),
			this.scene
		)

		this.backGearBox = new OBB(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 0.5, this.plane.position.z + 2),
			new THREE.Vector3(8, 2, 2), 
			new THREE.Euler(),
			this.scene
		)

		this.wingBox = new OBB(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 6, this.plane.position.z + 0.5),
			new THREE.Vector3(35, 1, 6), 
			new THREE.Euler(),
			this.scene
		)

		this.tailBox = new OBB(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 5, this.plane.position.z + 16),
			new THREE.Vector3(10, 6, 6), 
			new THREE.Euler(),
			this.scene
		)

		this.bodyBox = new OBB(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 4, this.plane.position.z + 2),
			new THREE.Vector3(6, 5, 20), 
			new THREE.Euler(),
			this.scene
		)

		this.finishedLoading() 
	}

	// load plane
	async initPlane() {
		loadObjects(glbLoader, 
		[this.modelUrl], 
		[this.id], 
		this.planeArr
		).then(() => this.planeLoadingDone(), () => this.errorLoading())
	}

	/* Movement Functions */
 
	// change level of thrust
	changeThrust(newVal) {
		this.goalThrustLevel = Math.min(Math.max(newVal, 0), 1);
	}

	changeRotation(rotationChange) {
		this.targetRotation.copy(new THREE.Euler(this.targetRotation.x + rotationChange.x, this.targetRotation.y + rotationChange.z, this.targetRotation.z + rotationChange.y))
		var forward = new THREE.Vector3(0, 0, -1)
		var backward = new THREE.Vector3(0, 0, 1)
		forward.applyEuler(new THREE.Euler(this.rotation.x, this.rotation.z, this.rotation.y))
		backward.applyEuler(new THREE.Euler(this.rotation.x, this.rotation.z, this.rotation.y))
	}

	// update plane position and velocity
	update(sps, r) {
		this.oldPos = this.plane.position.clone()
		var fps = sps
		var vb = this.velocity.length()

		var ab = this.acceleration.length()
		this.acceleration = new THREE.Vector3(0,0,0)

		this.thrustLevel += (this.goalThrustLevel - this.thrustLevel) * 0.1

		var thrustForce = this.thrustLevel * 3000;
		this.acceleration.add(calculateThrust(thrustForce, 400, forward));

		var dragAccel = calculateDrag(400, this.velocity.length(), 0.001, 174, backward)
		this.acceleration.add(dragAccel);

		if (!this.onRunway) {
			this.acceleration.y = -9.8
		}

		var an = this.acceleration.length()
		var m_acceleration = (an-ab)
		var integratedFactor = calculateLinearIntegration(m_acceleration, ab, 1/fps)

		var frameAcceleration = this.acceleration.clone();
		frameAcceleration.normalize()
		frameAcceleration.multiplyScalar(integratedFactor)
		this.e.add(frameAcceleration)

		this.velocity.add(frameAcceleration)

		var vn = this.velocity.length()
		var m = (vn-vb)
		var integratedFactor = calculateLinearIntegration(m, vb, 1/fps)

		var frameVelocity = this.velocity.clone();
		frameVelocity.normalize()
		frameVelocity.multiplyScalar(integratedFactor)

		
		var oldRotation = this.rotation.clone()
		lerpEuler(this.rotation, this.targetRotation, 0.9 * 1 / fps)
		lerpEuler(oldRotation, this.targetRotation, -0.9 * 1 / fps)
		this.updateRelativeObjects();

		let iVelocity = frameVelocity.clone().multiplyScalar(0.1)

		for (let i = 0; i < 10; i++) {
			this.plane.position.add(iVelocity);

			let gear1 = this.frontGearBox.checkMeshColliding(r) 
			let gear2 = this.backGearBox.checkMeshColliding(r)
			let crash1 = (this.wingBox.checkMeshColliding(r).collides || this.bodyBox.checkMeshColliding(r).collides)
			let tailstrike = this.tailBox.checkMeshColliding(r)


			if (gear2.collides) {
				this.onRunway = true 
				this.plane.position.y = 20.5
			} else {
				this.onRunway = false
			}

			if (gear1.collides) {
				let pass = false
				for (let x = 0; x < 5; x++) {
					this.plane.position.y += 0.02
					let gear1 = this.frontGearBox.checkMeshColliding(r, frameVelocity)
					if (!gear1.collides) {
						pass = true
						break;
					}
				}
				if (!pass) {
					this.rotation.x = oldRotation.x
					this.targetRotation.x = oldRotation.x
					this.updateRelativeObjects()
					let gear1 = this.frontGearBox.checkMeshColliding(r, frameVelocity)
					if (gear1.collides) {
						this.crashHandler()
						break;
					}
				}
				
			}


			if (tailstrike.collides) {
				this.rotation.copy(oldRotation)
				this.targetRotation.copy(oldRotation)
				this.updateRelativeObjects()
				let tailstrike = this.tailBox.checkMeshColliding(r, frameVelocity)
				if (tailstrike.collides) {
					this.crashHandler()
					break;
				}
			}

			if (crash1) {
				this.crashHandler()
				break;
			}

		}
		this.updateRelativeObjects()
		this.plane.rotation.copy(new THREE.Euler(this.rotation.x - defaultRotation.x, this.rotation.y - defaultRotation.y, this.rotation.z - defaultRotation.z))
		this.airspeed = new THREE.Vector3().subVectors(this.plane.position, this.oldPos).length() * fps

	}

	updateRelativeObjects() {
		// this.planeCamera.position.set(this.plane.position.x + 40, this.plane.position.y + 10, this.plane.position.z + 0);
		// this.planeCamera.rotation.x = 0
		// this.planeCamera.rotation.y = 1.5707

		this.planeCamera.position.set(this.plane.position.x, this.plane.position.y + 32, this.plane.position.z + 64);

		const relativeRotation = new THREE.Euler(this.rotation.x, this.rotation.z, -this.rotation.y)


		this.frontGearBox.setOrientation(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 1.25, this.plane.position.z - 5.5),
			relativeRotation,
			this.plane.position
		);

		this.backGearBox.setOrientation(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 0.5, this.plane.position.z),
			relativeRotation,
			this.plane.position
		); 

		this.wingBox.setOrientation(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 6, this.plane.position.z + 0.5),
			relativeRotation,
			this.plane.position
		);

		this.tailBox.setOrientation(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 5, this.plane.position.z + 16),
			relativeRotation,
			this.plane.position
		);

		this.bodyBox.setOrientation(
			new THREE.Vector3(this.plane.position.x, this.plane.position.y + 5, this.plane.position.z + 2),
			relativeRotation,
			this.plane.position
		); 
	}


}

export {Plane};